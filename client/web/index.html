<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0px;
            border: 0;
            overflow: hidden;
            /*  Disable scrollbars */
            display: block;
            /* No floating content on sides */
        }
    </style>
</head>

<body>
    <canvas id="canvas" style='position:absolute; left:0px; top:0px; width: 100%'></canvas>

    <script>
        function gameLoop(update, draw) {
            // Game loop
            let start = null;
            let prevTimestamp = null;
            const drawAndUpdate = (timestamp) => {
                // Initialization
                if (!prevTimestamp) {
                    start = timestamp;
                    prevTimestamp = timestamp;
                    requestAnimationFrame(drawAndUpdate);
                    return;
                }

                // Update and draw
                let progress = (timestamp - prevTimestamp) / 1000;
                update(progress);
                draw();

                // Some bookkeeping
                prevTimestamp = timestamp;
                requestAnimationFrame(drawAndUpdate);
            };

            drawAndUpdate();
        }

        function gameResources() {
            const res = {
                player: document.createElement('canvas')
            };

            res.player.width = 20;
            res.player.height = 20;
            const playerContext = res.player.getContext('2d');
            playerContext.fillStyle = 'red';
            playerContext.rect(0, 0, 20, 20);
            playerContext.fill();

            return { ...res };
        }

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const resources = gameResources();

        function gameExports() {
            function clearScreen() {
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            function drawPlayer(x, y) {
                ctx.drawImage(resources.player, 0, 0);
                ctx.fillStyle = "black";
            }

            return {
                clear_screen: clearScreen,
                draw_player: drawPlayer
            }
        }

        fetch("client.wasm").then(response =>
            response.arrayBuffer()
        ).then(bytes =>
            WebAssembly.instantiate(bytes, { env: gameExports() })
        ).then(results => {
            let module = { ...results.instance.exports };

            const KEY_STATE = {
                'UP': 1,
                'DOWN': 2
            };

            function processKey(key, keyState) {
                switch (key) {
                    case "ArrowLeft":
                        KEY_STATE === KEY_STATE.DOWN ? module.left_keyup() : module.left_keydown();
                        break;
                    case "ArrowRight":
                        KEY_STATE === KEY_STATE.DOWN ? module.right_keyup() : module.right_keydown();
                        break;
                    case "ArrowUp":
                        KEY_STATE === KEY_STATE.DOWN ? module.up_keyup() : module.up_keydown();
                        break;
                    case "ArrowDown":
                        KEY_STATE === KEY_STATE.DOWN ? module.down_keyup() : module.down_keydown();
                        break;
                    case " ":
                        break;
                }
            }
            document.addEventListener('keydown', e => processKey(e.key, KEY_STATE.DOWN));
            document.addEventListener('keyup', e => processKey(e.key, KEY_STATE.UP));

            function resize() {
                canvas.width = window.innerWidth * 0.8;
                canvas.height = window.innerHeight * 0.8;
                module.resize(canvas.width, canvas.height);
            }
            window.addEventListener('resize', () => {
                resize();
            });

            resize();

            gameLoop((timestamp) => {
                module.update(timestamp)
            }, () => {
                module.draw()
            });
        }).catch(e => {
            console.log('Error occured', e);
        })
    </script>
</body>

</html>